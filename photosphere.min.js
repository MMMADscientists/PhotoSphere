Connection=function(a,e,g,c){c=c||THREE.ImageUtils.loadTexture($("#door")[0].src);var f=new THREE.PlaneGeometry(1,2),b=new THREE.MeshLambertMaterial({map:c,transparent:true});b.side=THREE.DoubleSide;THREE.Mesh.call(this,f,b);this.position=a;this.destinationID=e;this.connectionID=g;var d=new THREE.Vector3().subVectors(new THREE.Vector3(0,0,1),this.position);this.lookAt(d)};Connection.prototype=Object.create(THREE.Mesh.prototype);$(document).ready(function(){THREE.ImageUtils.crossOrigin="anonymous";var b=Property.fromWebpage();b.bind();var a=function(){requestAnimationFrame(a);b.render()};a()});Property=function(){this.scene=new THREE.Scene();if($("#viewer").length>0){var a=$("#viewer")[0];this.camera=new THREE.PerspectiveCamera(Property.FOV,a.width/a.height,Property.NEAR,Property.FAR);this.renderer=new THREE.WebGLRenderer({canvas:a});this.renderer.setSize(a.width,a.height)}else{this.camera=new THREE.PerspectiveCamera(Property.FOV,Property.ASPECT,Property.NEAR,Property.FAR);this.renderer=new THREE.CanvasRenderer();this.renderer.setSize(window.innerWidth,window.innerHeight);$("body").append(this.renderer.domElement)}this.scene.add(new THREE.AmbientLight(16777215));this.rooms={};this.currentRoom=null;this.lock=false;this.holding=false};Property.prototype.onClick=function(a,d){if(this.holding){this.holding=false;return}if(this.currentRoom!==null){var c=this.currentRoom.getConnectionsClicked(a,d,this.camera,this.renderer.domElement);if(c.intersections.length>0&&c.intersections[0].object instanceof Connection){var b=c.intersections[0];this.setCurrentRoom(b.object.destinationID)}}};Property.prototype.onPress=function(a,b){if(this.currentRoom!==null){this.currentRoom.startRotate(a,b)}};Property.prototype.onMove=function(a,b){if(this.currentRoom!==null){this.currentRoom.rotate(a,b)}};Property.prototype.onRelease=function(){if(this.currentRoom!==null){this.currentRoom.endRotate()}};Property.prototype.onMouseWheel=function(a){a.preventDefault();if(a.deltaY<0){this.camera.fov=Math.max(Property.FOV_MINIMUM,this.camera.fov/Property.SCALE);this.camera.updateProjectionMatrix()}else{if(a.deltaY>0){this.camera.fov=Math.min(Property.FOV_MAXIMUM,this.camera.fov*Property.SCALE);this.camera.updateProjectionMatrix()}}};Property.prototype.onEditConnection=function(g,f){if(this.currentRoom!==null){this.lock=true;var e=this.currentRoom.getConnectionsClicked(g,f,this.camera,this.renderer.domElement);if(e.intersections.length>0&&e.intersections[0].object instanceof Connection){var a=e.intersections[0];var c=new CustomEvent("propertyEdit",{detail:{id:a.object.connectionID}});window.dispatchEvent(c);Jockey.send("propertyEdit",{id:a.object.connectionID},function(){console.log("Applications have received propertyEdit!")});console.log("Dispatched propertyEdit Event")}else{var h=e.ray.direction.normalize().multiplyScalar(e.intersections[0].distance-10);var b=this.currentRoom.rotation.clone();b.y*=-1;var d=new THREE.Quaternion();d.setFromEuler(b);h.applyQuaternion(d);var i=new CustomEvent("propertyCreate",{detail:{x:h.x,y:h.y,z:h.z}});window.dispatchEvent(i);console.log("Dispatched propertyCreate Event");Jockey.send("propertyCreate",{x:h.x,y:h.y,z:h.z},function(){console.log("Applications have received propertyCreate!")})}}};Property.prototype.bind=function(){this.renderer.domElement.addEventListener("mousedown",function(a){this.onPress(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("mousemove",function(a){this.onMove(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("mouseup",function(a){this.onRelease(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("mouseout",function(a){this.onRelease(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("mousewheel",this.onMouseWheel.bind(this));this.renderer.domElement.addEventListener("click",function(a){this.onClick(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("touchstart",function(b){var a=b.touches[0];this.onPress(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("touchmove",function(b){var a=b.touches[0];this.onMove(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("touchend",function(b){var a=b.touches[0];this.onRelease(a.clientX,a.clientY)}.bind(this));this.renderer.domElement.addEventListener("touchleave",function(b){var a=b.touches[0];this.onRelease(a.clientX,a.clientY)}.bind(this));Hammer(this.renderer.domElement).on("hold",function(b){this.holding=true;var a=b.gesture.touches[0];this.onEditConnection(a.clientX,a.clientY)}.bind(this))};Property.prototype.render=function(){this.renderer.render(this.scene,this.camera)};Property.prototype.addRoom=function(a,b){this.rooms[a]=b};Property.prototype.setCurrentRoom=function(a){if(this.currentRoom!==null){this.scene.remove(this.currentRoom)}this.currentRoom=this.rooms[a];this.scene.add(this.currentRoom)};Property.FOV=75;Property.ASPECT=window.innerWidth/window.innerHeight;Property.NEAR=0.1;Property.FAR=1000;Property.SCALE=1.25;Property.FOV_MINIMUM=5;Property.FOV_MAXIMUM=75;Property.fromWebpage=function(a){a=a||".texture";var b=new Property();$(a).each(function(){var d=new Room(this.id,THREE.ImageUtils.loadTexture(this.src));var c=metadata[this.id];c.forEach(function(e){var f=new THREE.Vector3(parseFloat(e.doorX),parseFloat(e.doorY),parseFloat(e.doorZ));d.add(new Connection(f,e.idDestination,e.idConnection))});b.addRoom(this.id,d);b.setCurrentRoom(this.id)});if(defaultRoom!==""){b.setCurrentRoom(defaultRoom)}return b};Room=function(d,b){b.image.crossOrigin="anonymous";var c=new THREE.SphereGeometry(Room.RADIUS,Room.WIDTH_SEGMENTS,Room.HEIGHT_SEGMENTS);var a=new THREE.MeshLambertMaterial({map:b});a.side=THREE.BackSide;a.overdraw=true;THREE.Mesh.call(this,c,a);this.id=d;this.projector=new THREE.Projector();this.isRotating=false;this.rotateStart=new THREE.Vector2();this.rotateEnd=new THREE.Vector2()};Room.prototype=Object.create(THREE.Mesh.prototype);Room.prototype.getConnectionsClicked=function(a,g,d,c){var e=c.parentNode;var f=new THREE.Vector3(((a-c.offsetLeft)/c.width)*2-1,-((g-c.offsetTop)/c.height)*2+1,0.5);this.projector.unprojectVector(f,d);var b=new THREE.Raycaster(d.position,f.sub(d.position).normalize());return{intersections:b.intersectObject(this,true),ray:b.ray}};Room.prototype.startRotate=function(a,b){if(!this.isRotating){this.isRotating=true;this.rotateStart.set(a,b)}};Room.prototype.rotate=function(a,c){if(this.isRotating){this.rotateEnd.set(a,c);var b=new THREE.Vector2().subVectors(this.rotateEnd,this.rotateStart).divideScalar(750);this.rotateStart=this.rotateEnd.clone();this.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,this.rotation.x-b.y));this.rotation.y-=b.x}};Room.prototype.endRotate=function(){this.isRotating=false};Room.RADIUS=25;Room.WIDTH_SEGMENTS=50;Room.HEIGHT_SEGMENTS=50;